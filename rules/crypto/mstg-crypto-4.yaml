rules:
  - id: MSTG-CRYPTO-4
    severity: WARNING
    languages: [java]
    metadata:
      company: IMQ Minded Security
      author: Maurizio Siddu
      owasp-mobile: M5
      category: security
      area: cryptography
      verification-level: ["L1","L2"]
      references:
        - https://mobile-security.gitbook.io/mobile-security-testing-guide/android-testing-guide/0x05e-testing-cryptography
    message: >-
      The Android application is using a deprecated cryptographic algorithm.
    patterns:
      - pattern-either:
          - patterns: 
              - pattern: |
                  Cipher $CIP = Cipher.getInstance("=~/.*\/ECB\/.*/", ...);
          - patterns: 
              - pattern: |
                  Cipher $CIP = Cipher.getInstance("=~/.*\/CBC\/(PKCS5|PKCS7)Padding/", ...);
          - patterns:                   
              - pattern: |
                  Cipher $CIP = Cipher.getInstance("=~/(3DES|DESede|DES|Blowfish)\/.*\/.*/", ...);
          - patterns:
              - pattern: |
                  SecretKeyFactory $VAR = SecretKeyFactory.getInstance("=~/(3DES|DESede|DES)/", ...);
          - patterns:                   
              - pattern: |
                  SecureRandom $SR = SecureRandom.getInstance($VAR, "=~/Crypto/");
          - patterns:                   
              - pattern-inside: |
                  KeyGenParameterSpec $KGPS = new KeyGenParameterSpec.Builder(...)
                    . ...
                    .setBlockModes(KeyProperties.BLOCK_MODE_ECB)
                    . ...
                    .build();
          - patterns:                     
              - pattern-inside: |
                  KeyGenParameterSpec $KGPS = new KeyGenParameterSpec.Builder(...)
                     . ...
                     .setBlockModes(KeyProperties.BLOCK_MODE_CBC)
                     . ...
                     .setEncryptionPaddings($PAD)
                     . ...
                     .build();
              - metavariable-regex:
                  metavariable: $PAD
                  regex: KeyProperties\.ENCRYPTION_PADDING_(PKCS7|PKCS5)
          - patterns:
              - pattern-inside: |
                  $KG.initialize(new KeyGenParameterSpec.Builder(...)
                    . ...
                    .setBlockModes(KeyProperties.BLOCK_MODE_ECB)
                    . ...
                    .build());
          - patterns:
              - pattern-inside: |
                  $KG.initialize(new KeyGenParameterSpec.Builder(...)
                    . ...
                    .setBlockModes(KeyProperties.BLOCK_MODE_CBC)
                    . ...
                    .setEncryptionPaddings($PAD)
                    . ...
                    .build());
              - metavariable-regex:
                    metavariable: $PAD
                    regex: KeyProperties\.ENCRYPTION_PADDING_(PKCS7|PKCS5)